<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>גמ"ח קרן אסתר - טופס בקשה</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&family=Frank+Ruhl+Libre:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Assistant', sans-serif; background-color: #f1f5f9; }
        .font-serif-title { font-family: 'Frank Ruhl Libre', serif; }
        
        /* Custom Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }

        /* Input Focus Effects */
        .input-group:focus-within label { color: #1e3a8a; }
        .input-group:focus-within input, .input-group:focus-within select { border-color: #1e3a8a; box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1); }

        /* Print Styles */
        @media print {
            body { background: white; margin: 0; padding: 0; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            @page { size: A4 portrait; margin: 1.5cm; }
            .legal-paper { width: 100%; max-width: 100%; }
        }
        .print-only { display: none; }
        
        /* Legal Paper Styling */
        .legal-paper {
            font-family: 'David', 'Times New Roman', serif;
            line-height: 1.3;
            color: black;
            font-size: 11pt;
        }
        .legal-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 5px; margin-bottom: 15px; }
        .legal-field { font-weight: bold; padding: 0 5px; }
        .guarantor-box { border: 1px solid #000; padding: 8px; margin-bottom: 8px; font-size: 10pt; }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Configuration ---
        // *** חשוב! הדבק כאן את הקישור שקיבלת מגוגל סקריפט ***
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwNAlwhFVlUnyYpPhjUaw_CWlvigtRJOEmM7qyFNHvXo0eksT9diQkcJsfUL8wogKGB-g/exec"; 
        
        // --- Constants ---
        const ISRAELI_BANKS = [
            { code: '12', name: 'בנק הפועלים' },
            { code: '10', name: 'בנק לאומי' },
            { code: '11', name: 'בנק דיסקונט' },
            { code: '52', name: 'בנק פאג"י' },
            { code: '20', name: 'בנק מזרחי טפחות' },
            { code: '17', name: 'בנק מרכנתיל' },
            { code: '31', name: 'הבנק הבינלאומי' },
            { code: '09', name: 'בנק הדואר' },
            { code: '04', name: 'בנק יהב' },
            { code: '46', name: 'בנק מסד' },
            { code: '14', name: 'בנק אוצר החייל' }
        ];

        // --- Helpers ---
        const getHebrewDate = () => "י' בשבט תשפ\"ד"; // Placeholder

        const calculateGuarantors = (amount) => {
            if (!amount) return 0;
            const num = parseInt(amount);
            if (num <= 10000) return 2;
            return 2 + Math.ceil((num - 10000) / 10000);
        };

        // --- VALIDATION LOGIC ---
        const isValidIsraeliID = (id) => {
            let strId = String(id).trim();
            if (strId.length > 9 || strId.length < 5) return false;
            strId = strId.padStart(9, '0');
            return Array.from(strId, Number).reduce((counter, digit, i) => {
                const step = digit * ((i % 2) + 1);
                return counter + (step > 9 ? step - 9 : step);
            }) % 10 === 0;
        };

        const isValidMobile = (phone) => {
            const regex = /^05\d{8}$/;
            return regex.test(phone);
        };

        const validateSpecificBank = (bankString, accountNum) => {
            if (!accountNum) return ''; 
            const match = bankString.match(/\((\d{2})\)/);
            if (!match) return ''; 
            const bankCode = match[1];
            const len = accountNum.length;
            const isNumeric = /^\d+$/.test(accountNum);
            if (!isNumeric) return 'מספר חשבון חייב להכיל ספרות בלבד';
            switch (bankCode) {
                case '12': if (len !== 6) return 'בבנק הפועלים מס\' החשבון חייב להיות בן 6 ספרות בדיוק'; break;
                case '52': if (len !== 6) return 'בבנק פאג"י מס\' החשבון חייב להיות בן 6 ספרות בדיוק'; break;
                case '10': if (len < 7 || len > 13) return 'בבנק לאומי מס\' החשבון אינו תקין (אורך שגוי)'; break;
                case '11': if (len < 7 || len > 13) return 'בבנק דיסקונט מס\' החשבון אינו תקין (אורך שגוי)'; break;
                default: if (len < 6 || len > 13) return 'מספר חשבון לא תקין';
            }
            return '';
        };

        // --- UI Components ---
        const InputField = ({ label, type, name, value, onChange, onBlur, placeholder, required = true, error, className, children }) => (
            <div className={`input-group mb-4 ${className}`}>
                <label className="block text-gray-600 text-xs font-bold mb-1 tracking-wide">
                    {label} {required && <span className="text-red-500">*</span>}
                </label>
                <input 
                    type={type} name={name} value={value} onChange={onChange} onBlur={onBlur}
                    className={`w-full px-3 py-2 rounded border ${error ? 'border-red-500 bg-red-50' : 'border-gray-300 bg-white'} outline-none transition-all duration-200 text-gray-800 text-sm h-10`}
                    placeholder={placeholder} required={required}
                />
                {error && <p className="text-red-500 text-xs mt-1 font-medium flex items-center"><span className="mr-1">⚠</span> {error}</p>}
                {children}
            </div>
        );

        const SelectField = ({ label, name, value, onChange, options, required = true, className }) => (
            <div className={`input-group mb-4 ${className}`}>
                <label className="block text-gray-600 text-xs font-bold mb-1 tracking-wide">
                    {label} {required && <span className="text-red-500">*</span>}
                </label>
                <select 
                    name={name} value={value} onChange={onChange}
                    className="w-full px-3 py-2 rounded border border-gray-300 bg-white outline-none transition-all duration-200 text-gray-800 text-sm h-10"
                    required={required}
                >
                    <option value="" disabled>בחר בנק...</option>
                    {options.map((opt, idx) => <option key={idx} value={`${opt.name} (${opt.code})`}>{opt.name} ({opt.code})</option>)}
                </select>
            </div>
        );

        // --- Main App ---
        const App = () => {
            const [step, setStep] = useState(1);
            const [submitting, setSubmitting] = useState(false);
            const [errors, setErrors] = useState({ idNumber: '', phone: '', bankAccount: '' });
            
            // New state to allow overriding bank validation
            const [forceBankSubmit, setForceBankSubmit] = useState(false);

            const [formData, setFormData] = useState({
                amount: '', firstName: '', lastName: '', idNumber: '', address: '', phone: '', additionalPhone: '',
                email: '', bankName: '', bankBranch: '', bankAccount: ''
            });

            const guarantorsCount = calculateGuarantors(formData.amount);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData({ ...formData, [name]: value });
                
                if (errors[name]) setErrors({ ...errors, [name]: '' });
                
                // If user changes bank details, reset the forced submit permission
                if (name === 'bankName' || name === 'bankAccount') {
                    setForceBankSubmit(false);
                }

                if (name === 'bankName' && formData.bankAccount) {
                    const bankErr = validateSpecificBank(value, formData.bankAccount);
                    setErrors(prev => ({ ...prev, bankAccount: bankErr }));
                }
            };

            const handleBlur = (e) => {
                const { name, value } = e.target;
                let errorMsg = '';
                if (name === 'idNumber' && value && !isValidIsraeliID(value)) errorMsg = 'מספר זהות אינו תקין';
                else if (name === 'phone' && value && !isValidMobile(value)) errorMsg = 'מספר נייד לא תקין (חייב 10 ספרות, מתחיל ב-05)';
                else if (name === 'bankAccount' && value) {
                    if (formData.bankName) errorMsg = validateSpecificBank(formData.bankName, value);
                    else if (!/^\d{6,13}$/.test(value)) errorMsg = 'מספר חשבון לא תקין';
                }
                setErrors(prev => ({ ...prev, [name]: errorMsg }));
            };

            // *** Combined Submit Function (Validation -> Google Sheets -> Finish) ***
            const handleSubmitForm = async (e) => {
                e.preventDefault();
                
                // 1. Validations
                const idErr = (!isValidIsraeliID(formData.idNumber)) ? 'מספר זהות אינו תקין' : '';
                const phoneErr = (!isValidMobile(formData.phone)) ? 'מספר נייד לא תקין' : '';
                const bankErr = validateSpecificBank(formData.bankName, formData.bankAccount);

                setErrors({ idNumber: idErr, phone: phoneErr, bankAccount: bankErr });

                // 2. Logic to block execution
                // Hard Blocks (ID & Phone must be correct)
                if (idErr || phoneErr) return;

                // Soft Block (Bank): Block if there is an error AND user hasn't approved it yet
                if (bankErr && !forceBankSubmit) return;

                // 3. Send Data
                setSubmitting(true);
                
                if (GOOGLE_SCRIPT_URL && GOOGLE_SCRIPT_URL !== "PASTE_YOUR_URL_HERE") {
                    try {
                        await fetch(GOOGLE_SCRIPT_URL, {
                            method: "POST",
                            mode: "no-cors",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(formData)
                        });
                        console.log("Data sent");
                    } catch (error) {
                        console.error("Error sending data", error);
                    }
                } else {
                    console.warn("Google Script URL is missing");
                }

                // 4. Move to Final Step
                // Small delay to simulate processing
                setTimeout(() => {
                    setSubmitting(false);
                    setStep(2);
                }, 1000);
            };

            const handlePrint = () => window.print();
            const handleBack = () => setStep(1);

            return (
                <div className="min-h-screen bg-slate-100 flex flex-col items-center py-6 px-4">
                    
                    <div className="text-center mb-6 no-print w-full max-w-5xl">
                        <h1 className="text-3xl font-serif-title font-bold text-slate-800 tracking-tight">קרן אסתר</h1>
                        <p className="text-slate-500 font-medium text-sm">ע.ר. 580021475</p>
                    </div>

                    <div className="w-full max-w-6xl bg-white rounded shadow-2xl overflow-hidden no-print border-t-4 border-slate-800 animate-fade-in">
                        
                        {/* Simplified Progress Bar */}
                        <div className="flex w-full bg-slate-50 border-b border-slate-200">
                            <div className={`flex-1 py-3 text-center text-sm font-bold border-l border-slate-200 ${step === 1 ? 'text-slate-800 bg-white' : 'text-slate-400'}`}>1. מילוי פרטים</div>
                            <div className={`flex-1 py-3 text-center text-sm font-bold ${step === 2 ? 'text-slate-800 bg-white' : 'text-slate-400'}`}>2. סיום והדפסה</div>
                        </div>

                        <div className="p-8">
                            {step === 1 && (
                                <form onSubmit={handleSubmitForm}>
                                    <div className="flex items-center justify-between mb-6">
                                        <h2 className="text-xl font-bold text-slate-800 border-r-4 border-slate-800 pr-3">טופס בקשת הלוואה</h2>
                                        {formData.amount && (
                                            <div className="bg-slate-100 text-slate-700 px-4 py-1 rounded text-sm font-bold">
                                                סה"כ ערבים נדרשים: {guarantorsCount}
                                            </div>
                                        )}
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        
                                        {/* Column 1 */}
                                        <div className="bg-slate-50 p-4 rounded border border-slate-100">
                                            <h3 className="text-xs font-bold text-slate-400 uppercase mb-4">פרטי אישיים</h3>
                                            <div className="grid grid-cols-2 gap-3">
                                                <InputField label="שם פרטי" name="firstName" value={formData.firstName} onChange={handleChange} placeholder="ישראל" type="text" className="col-span-1" />
                                                <InputField label="שם משפחה" name="lastName" value={formData.lastName} onChange={handleChange} placeholder="ישראלי" type="text" className="col-span-1" />
                                            </div>
                                            <InputField label="מספר זהות" name="idNumber" value={formData.idNumber} onChange={handleChange} onBlur={handleBlur} error={errors.idNumber} placeholder="000000000" type="text" />
                                            <InputField label="כתובת מלאה" name="address" value={formData.address} onChange={handleChange} placeholder="עיר, רחוב, מספר" type="text" />
                                        </div>
                                        
                                        {/* Column 2 */}
                                        <div className="bg-slate-50 p-4 rounded border border-slate-100">
                                            <h3 className="text-xs font-bold text-slate-400 uppercase mb-4">פרטי הלוואה ויצירת קשר</h3>
                                            <InputField label="סכום הלוואה (ש&quot;ח)" name="amount" value={formData.amount} onChange={handleChange} placeholder="5000" type="number" />
                                            <InputField label="טלפון נייד" name="phone" value={formData.phone} onChange={handleChange} onBlur={handleBlur} error={errors.phone} placeholder="0500000000" type="tel" />
                                            <InputField label="טלפון נוסף (לא חובה)" name="additionalPhone" value={formData.additionalPhone} onChange={handleChange} placeholder="נייח או נייד נוסף" type="tel" required={false} />
                                            <InputField label="דואר אלקטרוני" name="email" value={formData.email} onChange={handleChange} placeholder="mail@example.com" type="email" />
                                        </div>
                                        
                                        {/* Column 3 - Bank Details */}
                                        <div className="bg-slate-50 p-4 rounded border border-slate-100">
                                            <h3 className="text-xs font-bold text-slate-400 uppercase mb-4">פרטי חשבון להפקדה</h3>
                                            <SelectField label="בנק" name="bankName" value={formData.bankName} onChange={handleChange} options={ISRAELI_BANKS} />
                                            <div className="grid grid-cols-2 gap-3">
                                                <InputField label="סניף" name="bankBranch" value={formData.bankBranch} onChange={handleChange} placeholder="000" type="text" />
                                                <InputField 
                                                    label="מס' חשבון" 
                                                    name="bankAccount" 
                                                    value={formData.bankAccount} 
                                                    onChange={handleChange} 
                                                    onBlur={handleBlur} 
                                                    error={errors.bankAccount} 
                                                    placeholder="000000" 
                                                    type="text"
                                                >
                                                    {/* Bypass Error Checkbox */}
                                                    {errors.bankAccount && (
                                                        <div className="mt-2 flex items-start">
                                                            <input 
                                                                type="checkbox" 
                                                                id="forceBank" 
                                                                checked={forceBankSubmit} 
                                                                onChange={(e) => setForceBankSubmit(e.target.checked)}
                                                                className="mt-1 ml-2"
                                                            />
                                                            <label htmlFor="forceBank" className="text-xs text-gray-700 cursor-pointer">
                                                                מספר החשבון תקין, אשר בכל זאת
                                                            </label>
                                                        </div>
                                                    )}
                                                </InputField>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="mt-8 flex justify-end">
                                        <button 
                                            type="submit" 
                                            disabled={submitting}
                                            className={`bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 px-12 rounded shadow transition-all flex items-center gap-2 ${submitting ? 'opacity-70 cursor-wait' : ''}`}
                                        >
                                            {submitting ? 'שולח נתונים...' : 'סיום והדפסת שטר חוב'} 
                                            {!submitting && <span>&larr;</span>}
                                        </button>
                                    </div>
                                </form>
                            )}

                            {step === 2 && (
                                <div className="max-w-2xl mx-auto text-center py-6 animate-fade-in">
                                    <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <svg className="text-green-600 w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7" /></svg>
                                    </div>
                                    <h2 className="text-2xl font-bold text-slate-800 mb-8">הטופס הושלם בהצלחה</h2>
                                    <div className="flex gap-4 justify-center">
                                        <button onClick={handleBack} className="px-6 py-3 border border-slate-300 text-slate-600 font-bold rounded hover:bg-slate-50 transition-all">חזור</button>
                                        <button onClick={handlePrint} className="px-8 py-3 bg-slate-800 text-white font-bold rounded shadow hover:bg-slate-900 flex items-center gap-2 transition-all">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><path d="M6 14h12v8H6z"/></svg>
                                            הדפס שטר חוב
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                    <div className="mt-6 text-slate-400 text-xs no-print">© כל הזכויות שמורות לגמ"ח קרן אסתר</div>

                    {/* PRINT TEMPLATE */}
                    <div className="print-only legal-paper">
                        <div className="legal-header">
                            <h1 style={{fontSize: '20pt', fontWeight: 'bold', margin: '0'}}>שטר הלוואה והתחייבות</h1>
                            <h2 style={{fontSize: '14pt', fontWeight: 'normal', margin: '2px 0'}}>גמ"ח קרן אסתר (ע.ר. 580021475)</h2>
                        </div>
                        <div style={{display: 'flex', justifyContent: 'space-between', fontSize: '10pt', marginBottom: '10px'}}>
                            <span>תאריך הדפסה: {new Date().toLocaleDateString('he-IL')}</span>
                            <span>תאריך עברי: {getHebrewDate()}</span>
                        </div>
                        <div style={{marginBottom: '10px'}}>
                            <p style={{margin: '0 0 5px 0'}}>הנני החתום מטה:</p>
                            <div style={{display: 'flex', gap: '20px', flexWrap: 'wrap'}}>
                                <span>שם: <span className="legal-field">{formData.firstName} {formData.lastName}</span></span>
                                <span>ת.ז: <span className="legal-field">{formData.idNumber}</span></span>
                                <span>נייד: <span className="legal-field">{formData.phone}</span></span>
                                {formData.additionalPhone && <span>טלפון נוסף: <span className="legal-field">{formData.additionalPhone}</span></span>}
                            </div>
                            <div style={{marginTop: '5px'}}>כתובת: <span className="legal-field">{formData.address}</span></div>
                        </div>
                        <div style={{backgroundColor: '#f0f0f0', padding: '5px', border: '1px solid #ddd', marginBottom: '10px'}}>
                            <b>פרטי הבקשה:</b> הלוואה ע"ס <span className="legal-field" style={{fontSize: '1.1em'}}>{formData.amount} ₪</span>.
                            <br/>
                            פרטי חשבון להעברה: {formData.bankName}, סניף {formData.bankBranch}, ח-ן {formData.bankAccount}.
                        </div>
                        <p style={{margin: '5px 0', fontSize: '10pt'}}>
                            הנני מתחייב להחזיר את מלוא סכום ההלוואה בתשלומים, באמצעות הוראת קבע (אסמכתא: <b>דיגיטלית</b>).
                            ידוע לי כי אי פירעון של אחד התשלומים יעמיד את היתרה לפירעון מיידי, והגמ"ח רשאי לגבות את החוב מכל נכסיי ומנכסי הערבים, הן ע"פ דין תורה והן ע"פ חוק.
                        </p>
                        <div style={{marginTop: '20px', marginBottom: '20px'}}>
                            <b>חתימת הלווה:</b> _________________________
                        </div>
                        <hr style={{border: '1px solid black', margin: '15px 0'}} />
                        <h3 style={{textDecoration: 'underline', textAlign: 'center', fontSize: '12pt', margin: '10px 0'}}>כתב ערבות</h3>
                        <p style={{fontSize: '10pt', margin: '0 0 10px 0'}}>
                            אנו החתומים מטה ערבים בזה ערבות בלתי חוזרת, ביחד ולחוד, לכל התחייבויות הלווה הנ"ל כלפי גמ"ח "קרן אסתר". אנו מוותרים בזה על הצורך לדרוש תחילה את החוב מאת הלווה.
                        </p>
                        <div style={{display: 'flex', flexWrap: 'wrap', gap: '10px'}}>
                            {Array.from({ length: guarantorsCount }).map((_, i) => (
                                <div key={i} className="guarantor-box" style={{width: '100%'}}>
                                    <div style={{fontWeight: 'bold', marginBottom: '5px'}}>ערב מס' {i + 1}:</div>
                                    <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '10px'}}>
                                        <div style={{width: '48%'}}>שם: _______________________</div>
                                        <div style={{width: '48%'}}>ת.ז: _________________</div>
                                    </div>
                                    <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '10px'}}>
                                        <div style={{width: '48%'}}>כתובת: ____________________</div>
                                        <div style={{width: '48%'}}>טלפון: ________________</div>
                                    </div>
                                    <div style={{textAlign: 'left', marginTop: '5px'}}>
                                        <b>חתימה:</b> ____________________
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
